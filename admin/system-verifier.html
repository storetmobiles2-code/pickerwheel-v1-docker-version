<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PickerWheel System Verifier - Admin Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .admin-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .control-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }

        .control-section h3 {
            margin-bottom: 15px;
            color: #ffd700;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        input, select {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .result-card h4 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .prize-list {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }

        .prize-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prize-item:last-child {
            border-bottom: none;
        }

        .compliance-check {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .compliance-check.failed {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-danger { background: #dc3545; }

        @media (max-width: 768px) {
            .control-panel {
                grid-template-columns: 1fr;
            }
        }

        /* Configuration Tables */
        .config-tables {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .config-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .config-table th,
        .config-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }

        .config-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            color: #fff;
        }

        .config-table td {
            color: #e0e0e0;
        }

        .config-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #17a2b8);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        #progressText {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: #17a2b8;
        }

        @media (max-width: 768px) {
            .config-tables {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß PickerWheel System Verifier</h1>
        
        <div class="admin-warning">
            <strong>‚ö†Ô∏è ADMIN TOOL ONLY</strong><br>
            This tool simulates multiple spins to verify system integrity and availability compliance.
        </div>

        <div class="control-panel">
            <div class="control-section">
                <h3>üéØ Test Configuration</h3>
                
                <div class="form-group">
                    <label for="spinCount">Number of Spins:</label>
                    <select id="spinCount">
                        <option value="50">50 Spins</option>
                        <option value="100" selected>100 Spins</option>
                        <option value="150">150 Spins</option>
                        <option value="200">200 Spins</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="testDate">Simulation Date:</label>
                    <input type="date" id="testDate" value="2025-09-22">
                </div>

                <div class="form-group">
                    <label for="adminPassword">Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password">
                </div>

                <button onclick="runVerificationTest()" id="runTestBtn">
                    üöÄ Run Verification Test
                </button>
            </div>

            <div class="control-section">
                <h3>üìä Expected Results</h3>
                <div id="expectedResults">
                    <p>Select a date to see expected available prizes...</p>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <h3>üìà Test Results</h3>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">Ready to start...</div>

            <div class="compliance-check" id="complianceCheck">
                <h4>üîç Compliance Verification</h4>
                <div id="complianceResults">Waiting for test results...</div>
            </div>

            <div class="results-grid">
                <div class="result-card">
                    <h4>üèÜ Prize Distribution</h4>
                    <div class="prize-list" id="prizeDistribution">
                        No results yet...
                    </div>
                </div>

                <div class="result-card">
                    <h4>‚ö†Ô∏è Violations & Issues</h4>
                    <div class="prize-list" id="violationsList">
                        No violations detected...
                    </div>
                </div>
            </div>
        </div>

        <div class="results-section">
            <h3>üìã Rare & Ultra-Rare Items Configuration</h3>
            <div id="rareItemsConfig" class="results-content">
                <div class="loading-message">Loading configuration...</div>
            </div>
        </div>

        <div class="results-section">
            <h3>üìä Simulation Results</h3>
            <div id="simulationResults" class="results-content">
                Run a simulation to see results here...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9080';
        let testRunning = false;

        // Update expected results when date changes
        document.getElementById('testDate').addEventListener('change', function() {
            updateExpectedResults();
            loadRareItemsConfiguration(); // Reload config for new date
        });
        
        // Load rare items configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadRareItemsConfiguration();
        });

        async function loadRareItemsConfiguration() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/csv/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_password: 'myTAdmin2025' })
                });
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load CSV configuration');
                }
                
                displayRareItemsConfiguration(data.csv_content);
            } catch (error) {
                console.error('Failed to load rare items configuration:', error);
                document.getElementById('rareItemsConfig').innerHTML = 
                    '<div class="error-message">‚ùå Failed to load configuration</div>';
            }
        }

        function displayRareItemsConfiguration(csvContent) {
            const lines = csvContent.split('\n').slice(1); // Skip header
            const selectedDate = document.getElementById('testDate').value;
            const rareItems = [];
            const ultraRareItems = [];
            
            lines.forEach(line => {
                if (!line.trim()) return;
                
                const [name, category, quantity, perDay, dates] = line.split(',').map(s => s.trim());
                
                // Check if item is available on selected date
                const availableDates = dates ? dates.split('|') : [];
                const isAvailableOnDate = availableDates.length === 0 || availableDates.includes(selectedDate);
                
                // Only include items that are available on the selected date
                if (isAvailableOnDate) {
                    const itemConfig = {
                        name,
                        totalQuantity: quantity || 'Unlimited',
                        perDay: perDay || 'N/A',
                        availableDates: dates || 'Random days',
                        dateCount: dates ? dates.split('|').length : 'Variable',
                        availabilityStatus: availableDates.length === 0 ? 'Random availability' : 'Scheduled'
                    };
                    
                    if (category === 'Rare') {
                        rareItems.push(itemConfig);
                    } else if (category === 'Ultra Rare') {
                        ultraRareItems.push(itemConfig);
                    }
                }
            });
            
            let configHtml = `
                <div class="date-header" style="text-align: center; margin-bottom: 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    <h4 style="margin: 0; color: #17a2b8;">üìÖ Available Rare & Ultra-Rare Items for ${selectedDate}</h4>
                </div>
                <div class="config-tables">
                    <div class="config-table-container">
                        <h4 style="color: #ffc107; margin-bottom: 15px;">‚≠ê Rare Items Available Today (${rareItems.length})</h4>
                        ${rareItems.length > 0 ? `
                        <table class="config-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Total Qty</th>
                                    <th>Per Day Limit</th>
                                    <th>Availability</th>
                                    <th>Expected Wins</th>
                                </tr>
                            </thead>
                            <tbody>` : '<div style="color: #ffc107; text-align: center; padding: 20px;">No Rare items available on this date</div>'}
            `;
            
            if (rareItems.length > 0) {
                rareItems.forEach(item => {
                    const expectedWins = item.perDay === '1/day' ? '1' : item.perDay;
                    
                    configHtml += `
                        <tr>
                            <td><strong>${item.name}</strong></td>
                            <td>${item.totalQuantity}</td>
                            <td style="color: #ffc107; font-weight: bold;">${item.perDay}</td>
                            <td>${item.availabilityStatus}</td>
                            <td style="color: #ffc107; font-weight: bold;">${expectedWins}</td>
                        </tr>
                    `;
                });
                
                configHtml += `
                            </tbody>
                        </table>`;
            }
            
            configHtml += `
                    </div>
                    
                    <div class="config-table-container">
                        <h4 style="color: #ff6b6b; margin-bottom: 15px;">üî• Ultra Rare Items Available Today (${ultraRareItems.length})</h4>
                        ${ultraRareItems.length > 0 ? `
                        <table class="config-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Total Qty</th>
                                    <th>Per Day Limit</th>
                                    <th>Availability</th>
                                    <th>Expected Wins</th>
                                </tr>
                            </thead>
                            <tbody>` : '<div style="color: #ff6b6b; text-align: center; padding: 20px;">No Ultra Rare items available on this date</div>'}
            `;
            
            if (ultraRareItems.length > 0) {
                ultraRareItems.forEach(item => {
                    const expectedWins = item.perDay === '1/day' ? '1' : item.perDay;
                    
                    configHtml += `
                        <tr>
                            <td><strong>${item.name}</strong></td>
                            <td>${item.totalQuantity}</td>
                            <td style="color: #ff6b6b; font-weight: bold;">${item.perDay}</td>
                            <td>${item.availabilityStatus}</td>
                            <td style="color: #ff6b6b; font-weight: bold;">${expectedWins}</td>
                        </tr>
                    `;
                });
                
                configHtml += `
                            </tbody>
                        </table>`;
            }
            
            configHtml += `
                    </div>
                </div>
                
                <div class="config-summary">
                    <h4>üìä Summary for ${selectedDate}</h4>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-label">Rare Items Available:</span>
                            <span class="stat-value" style="color: #ffc107;">${rareItems.length}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Ultra Rare Items Available:</span>
                            <span class="stat-value" style="color: #ff6b6b;">${ultraRareItems.length}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Limited Items Today:</span>
                            <span class="stat-value" style="color: #17a2b8;">${rareItems.length + ultraRareItems.length}</span>
                        </div>
                    </div>
                    ${(rareItems.length === 0 && ultraRareItems.length === 0) ? 
                        '<div style="text-align: center; margin-top: 15px; padding: 10px; background: rgba(255,193,7,0.1); border-radius: 8px; color: #ffc107;"><strong>‚ö†Ô∏è No rare or ultra-rare items available on this date</strong><br>Only common items can be won today</div>' : 
                        '<div style="text-align: center; margin-top: 15px; padding: 10px; background: rgba(40,167,69,0.1); border-radius: 8px; color: #28a745;"><strong>‚úÖ Limited items are available for testing</strong><br>Simulation will validate against these limits</div>'
                    }
                </div>
            `;
            
            document.getElementById('rareItemsConfig').innerHTML = configHtml;
        }

        async function updateExpectedResults() {
            const testDate = document.getElementById('testDate').value;
            const expectedDiv = document.getElementById('expectedResults');
            
            try {
                // Fetch available prizes for the selected date
                const response = await fetch(`${API_BASE}/api/prizes/available?date=${testDate}`);
                const data = await response.json();
                
                if (data.success) {
                    let html = `<h4>Available on ${testDate}:</h4>`;
                    
                    const categories = {
                        'Ultra Rare': [],
                        'Rare': [],
                        'Common': []
                    };
                    
                    data.prizes.forEach(prize => {
                        const category = prize.category_display || 'Unknown';
                        if (!categories[category]) categories[category] = [];
                        categories[category].push(prize);
                    });
                    
                    Object.keys(categories).forEach(category => {
                        if (categories[category].length > 0) {
                            html += `<p><strong>${category}:</strong> ${categories[category].length} prizes</p>`;
                        }
                    });
                } else {
                    html = '<p style="color: #ffc107;">Could not fetch expected results</p>';
                }
                
                expectedDiv.innerHTML = html;
            } catch (error) {
                expectedDiv.innerHTML = '<p style="color: #dc3545;">Error fetching expected results</p>';
            }
        }

        async function runVerificationTest() {
            if (testRunning) return;
            
            const spinCount = parseInt(document.getElementById('spinCount').value);
            const testDate = document.getElementById('testDate').value;
            const adminPassword = document.getElementById('adminPassword').value;
            
            if (!adminPassword) {
                alert('Please enter admin password');
                return;
            }
            
            testRunning = true;
            document.getElementById('runTestBtn').disabled = true;
            document.getElementById('runTestBtn').textContent = 'üîÑ Running Test...';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('progressText').textContent = 'Starting test...';
            
            const results = [];
            const violations = [];
            
            try {
                // Run the test spins
                for (let i = 1; i <= spinCount; i++) {
                    document.getElementById('progressText').textContent = `Running spin ${i} of ${spinCount}...`;
                    document.getElementById('progressFill').style.width = `${(i / spinCount) * 100}%`;
                    
                    const response = await fetch(`${API_BASE}/api/admin/test-spin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            admin_password: adminPassword,
                            user_id: `verifier_${i}`,
                            test_date: testDate
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        results.push({
                            spin: i,
                            prize: data.prize.name,
                            category: data.prize.category,
                            sector: data.sector_index
                        });
                    } else {
                        violations.push(`Spin ${i} failed: ${data.error || 'Unknown error'}`);
                    }
                    
                    // Small delay to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                document.getElementById('progressText').textContent = 'Analyzing results...';
                document.getElementById('progressFill').style.width = '100%';
                
                // Count prize distribution for validation
                const prizeCount = {};
                results.forEach(result => {
                    prizeCount[result.prize] = (prizeCount[result.prize] || 0) + 1;
                });
                
                // Validate quantity limits dynamically
                const quantityViolations = await validateQuantityLimits(prizeCount, testDate);
                violations.push(...quantityViolations);
                
                // Analyze results
                analyzeResults(results, violations, testDate);
                
            } catch (error) {
                document.getElementById('violationsList').innerHTML = `<div style="color: #dc3545;">Test failed: ${error.message}</div>`;
            }
            
            testRunning = false;
            document.getElementById('runTestBtn').disabled = false;
            document.getElementById('runTestBtn').textContent = 'üöÄ Run Verification Test';
            document.getElementById('progressText').textContent = 'Test completed!';
        }

        // Dynamic validation that fetches availability data from the API
        async function fetchAvailabilityData(testDate) {
            try {
                // Get available prizes for the test date
                const availableResponse = await fetch(`${API_BASE}/api/prizes/available?date=${testDate}`);
                const availableData = await availableResponse.json();
                
                // Get all prizes with their configuration
                const allPrizesResponse = await fetch(`${API_BASE}/api/prizes/all`);
                const allPrizesData = await allPrizesResponse.json();
                
                // Get inventory status for the test date
                const adminPassword = document.getElementById('adminPassword').value;
                const statsResponse = await fetch(`${API_BASE}/api/stats?date=${testDate}`);
                const statsData = await statsResponse.json();
                
                // Create availability map
                const availabilityMap = {};
                
                // Process all prizes first
                if (allPrizesData.success && allPrizesData.prizes) {
                    allPrizesData.prizes.forEach(prize => {
                        availabilityMap[prize.name] = {
                            id: prize.id,
                            category: prize.category,
                            isAvailableToday: false,
                            perDay: 0,
                            remainingQuantity: 0
                        };
                    });
                }
                
                // Update with available prizes for today
                if (availableData.success && availableData.prizes) {
                    availableData.prizes.forEach(prize => {
                        if (availabilityMap[prize.name]) {
                            availabilityMap[prize.name].isAvailableToday = true;
                            availabilityMap[prize.name].remainingQuantity = prize.remaining_quantity || 0;
                        }
                    });
                }
                
                // Update with inventory data
                if (statsData.success && statsData.inventory_status) {
                    statsData.inventory_status.forEach(item => {
                        if (availabilityMap[item.name]) {
                            availabilityMap[item.name].perDay = item.per_day_limit || item.initial_quantity || 0;
                            availabilityMap[item.name].remainingQuantity = item.remaining_quantity || 0;
                            availabilityMap[item.name].isUnlimited = item.is_unlimited === 1;
                        }
                    });
                }
                
                return availabilityMap;
            } catch (error) {
                console.error('Failed to fetch availability data:', error);
                return {};
            }
        }
        
        // Dynamic validation function that uses real-time data
        async function validateQuantityLimits(prizeCount, testDate) {
            const violations = [];
            
            try {
                // Fetch real-time availability data
                const availabilityMap = await fetchAvailabilityData(testDate);
                
                // Check each prize against its actual limits
                Object.entries(prizeCount).forEach(([prizeName, wonCount]) => {
                    const prizeData = availabilityMap[prizeName];
                    
                    if (prizeData) {
                        const category = prizeData.category;
                        const isRareOrUltraRare = category && (category.toLowerCase().includes('rare'));
                        
                        // Only validate rare and ultra-rare items
                        if (isRareOrUltraRare) {
                            // Check if item should be available on test date
                            if (!prizeData.isAvailableToday && wonCount > 0) {
                                violations.push(`üö´ ${prizeName} (${category}) won ${wonCount} times but not available on ${testDate}`);
                            } else if (prizeData.isAvailableToday && !prizeData.isUnlimited && wonCount > prizeData.perDay) {
                                violations.push(`‚ö†Ô∏è ${prizeName} (${category}) won ${wonCount} times, exceeds limit of ${prizeData.perDay}/day`);
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Validation error:', error);
                violations.push(`‚ö†Ô∏è Error validating prizes: ${error.message}`);
            }
            
            return violations;
        }

        function analyzeResults(results, violations, testDate) {
            // Count prize distribution with category tracking
            const prizeCount = {};
            const categoryCount = {};
            const rareItems = [];
            const ultraRareItems = [];
            
            results.forEach(result => {
                prizeCount[result.prize] = (prizeCount[result.prize] || 0) + 1;
                categoryCount[result.category] = (categoryCount[result.category] || 0) + 1;
                
                // Track rare and ultra rare items
                if (result.category && result.category.toLowerCase().includes('rare')) {
                    if (result.category.toLowerCase().includes('ultra')) {
                        ultraRareItems.push({
                            prize: result.prize,
                            spin: result.spin,
                            category: result.category
                        });
                    } else {
                        rareItems.push({
                            prize: result.prize,
                            spin: result.spin,
                            category: result.category
                        });
                    }
                }
            });
            
            // Create enhanced prize distribution display
            let distributionHtml = '<h5>üèÜ Prize Distribution Analysis:</h5>';
            
            // Rare Items Summary
            distributionHtml += `
                <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; border-radius: 8px; padding: 10px; margin: 10px 0;">
                    <h6 style="color: #ff6b6b; margin: 0 0 5px 0;">üî• Ultra Rare Items Won: ${ultraRareItems.length}</h6>
                    ${ultraRareItems.length > 0 ? 
                        ultraRareItems.map(item => 
                            `<div style="color: #ff6b6b; font-size: 0.9em;">‚Ä¢ Spin ${item.spin}: <strong>${item.prize}</strong></div>`
                        ).join('') : 
                        '<div style="color: #ff6b6b; font-size: 0.9em;">No Ultra Rare items won</div>'
                    }
                </div>
                
                <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107; border-radius: 8px; padding: 10px; margin: 10px 0;">
                    <h6 style="color: #ffc107; margin: 0 0 5px 0;">‚≠ê Rare Items Won: ${rareItems.length}</h6>
                    ${rareItems.length > 0 ? 
                        rareItems.map(item => 
                            `<div style="color: #ffc107; font-size: 0.9em;">‚Ä¢ Spin ${item.spin}: <strong>${item.prize}</strong></div>`
                        ).join('') : 
                        '<div style="color: #ffc107; font-size: 0.9em;">No Rare items won</div>'
                    }
                </div>
            `;
            
            // All Prize Counts with highlighting
            distributionHtml += '<h5 style="margin-top: 20px;">üìä Complete Prize Breakdown:</h5>';
            Object.entries(prizeCount)
                .sort((a, b) => b[1] - a[1])
                .forEach(([prize, count]) => {
                    // Determine if this is a rare item
                    const isUltraRare = ultraRareItems.some(item => item.prize === prize);
                    const isRare = rareItems.some(item => item.prize === prize);
                    
                    let itemClass = 'prize-item';
                    let itemStyle = '';
                    let icon = '';
                    
                    if (isUltraRare) {
                        itemStyle = 'background: rgba(255, 107, 107, 0.1); border-left: 4px solid #ff6b6b; color: #ff6b6b;';
                        icon = 'üî• ';
                    } else if (isRare) {
                        itemStyle = 'background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; color: #ffc107;';
                        icon = '‚≠ê ';
                    }
                    
                    distributionHtml += `<div class="${itemClass}" style="${itemStyle}">
                        <span>${icon}${prize}</span>
                        <span style="font-weight: bold;">${count}x</span>
                    </div>`;
                });
            
            // Category Summary with percentages
            distributionHtml += '<h5 style="margin-top: 20px;">üìà Category Distribution:</h5>';
            const totalSpins = results.length;
            Object.entries(categoryCount).forEach(([category, count]) => {
                const percentage = ((count / totalSpins) * 100).toFixed(1);
                let categoryStyle = '';
                let icon = '';
                
                if (category && category.toLowerCase().includes('ultra')) {
                    categoryStyle = 'color: #ff6b6b; font-weight: bold;';
                    icon = 'üî• ';
                } else if (category && category.toLowerCase().includes('rare')) {
                    categoryStyle = 'color: #ffc107; font-weight: bold;';
                    icon = '‚≠ê ';
                } else {
                    categoryStyle = 'color: #28a745;';
                    icon = 'üü¢ ';
                }
                
                distributionHtml += `<div class="prize-item" style="${categoryStyle}">
                    <span>${icon}${category}</span>
                    <span>${count}x (${percentage}%)</span>
                </div>`;
            });
            
            // Add statistical analysis
            distributionHtml += `
                <div style="background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; border-radius: 8px; padding: 10px; margin: 15px 0;">
                    <h6 style="color: #28a745; margin: 0 0 5px 0;">üìä Statistical Summary:</h6>
                    <div style="color: #28a745; font-size: 0.9em;">
                        ‚Ä¢ Total Spins: <strong>${totalSpins}</strong><br>
                        ‚Ä¢ Ultra Rare Rate: <strong>${((ultraRareItems.length / totalSpins) * 100).toFixed(2)}%</strong><br>
                        ‚Ä¢ Rare Rate: <strong>${((rareItems.length / totalSpins) * 100).toFixed(2)}%</strong><br>
                        ‚Ä¢ Common Rate: <strong>${(((totalSpins - ultraRareItems.length - rareItems.length) / totalSpins) * 100).toFixed(2)}%</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('prizeDistribution').innerHTML = distributionHtml;
            
            // Display violations (validation already done in runVerificationTest)
            let violationsHtml = '';
            if (violations.length === 0) {
                violationsHtml = '<div style="color: #28a745;"><span class="status-indicator status-success"></span>No violations detected!</div>';
            } else {
                violations.forEach(violation => {
                    violationsHtml += `<div style="color: #dc3545;"><span class="status-indicator status-danger"></span>${violation}</div>`;
                });
            }
            
            document.getElementById('violationsList').innerHTML = violationsHtml;
            
            // Compliance check with rare item analysis
            const complianceDiv = document.getElementById('complianceCheck');
            const totalSpinsForCompliance = results.length;
            const successRate = ((totalSpinsForCompliance - violations.length) / totalSpinsForCompliance * 100).toFixed(1);
            
            // Calculate rare item compliance
            const expectedRareRate = testDate === '2025-09-22' ? 'Low (limited availability)' : 'Varies by date';
            const actualRareRate = ((rareItems.length + ultraRareItems.length) / totalSpinsForCompliance * 100).toFixed(1);
            
            let complianceHtml = `
                <div><span class="status-indicator ${successRate > 95 ? 'status-success' : successRate > 80 ? 'status-warning' : 'status-danger'}"></span>
                Success Rate: ${successRate}% (${totalSpinsForCompliance - violations.length}/${totalSpinsForCompliance})</div>
                <div>Total Violations: ${violations.length}</div>
                <div>Test Date: ${testDate}</div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <strong>üéØ Rare Item Analysis:</strong><br>
                    ‚Ä¢ Ultra Rare Won: <span style="color: #ff6b6b; font-weight: bold;">${ultraRareItems.length}</span><br>
                    ‚Ä¢ Rare Won: <span style="color: #ffc107; font-weight: bold;">${rareItems.length}</span><br>
                    ‚Ä¢ Combined Rare Rate: <span style="color: #17a2b8; font-weight: bold;">${actualRareRate}%</span><br>
                    ‚Ä¢ Expected: ${expectedRareRate}
                </div>
            `;
            
            document.getElementById('complianceResults').innerHTML = complianceHtml;
            
            if (violations.length === 0 && successRate > 95) {
                complianceDiv.className = 'compliance-check';
            } else {
                complianceDiv.className = 'compliance-check failed';
            }
        }

        // Initialize
        updateExpectedResults();
    </script>
</body>
</html>
